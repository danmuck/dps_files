sequenceDiagram
  participant CLI as "cmd/key_store"
  participant KS as "KeyStore"
  participant MD as "MetaData"
  participant REF as "FileReference[]"
  participant DISK as "storage/*.kdht"
  participant META as "storage/metadata/*.toml"

  CLI->>KS: "LoadAndStoreFileLocal(local_path)"
  KS->>KS: "HashFile + CalculateBlockSize + TotalBlocks"
  KS->>MD: "PrepareMetaData(file_name, size, perms, ttl)"

  loop "for chunk_index in [0..TotalBlocks-1]"
    KS->>KS: "computeChunkKey(file_hash, chunk_index)"
    KS->>REF: "Create FileReference(key, data_hash, size, index)"
    KS->>DISK: "StoreFileReference(ref, chunk_bytes)"
    DISK-->>KS: "ack (or error)"
  end

  KS->>META: "fileToMemory(file) -> write TOML"
  KS-->>CLI: "File{MetaData, References}"

  CLI->>KS: "ReassembleFileToPath(file_hash, output_path)"
  KS->>META: "fileFromMemory(file_hash)"
  loop "for each reference"
    KS->>DISK: "LoadFileReferenceData(key)"
    KS->>KS: "Verify SHA-256 + chunk size"
  end
  KS-->>CLI: "reassembled file + final hash verified"
