sequenceDiagram
  participant CLI as "cmd/key_store"
  participant KS as "KeyStore"
  participant RH as "RemoteHandler"
  participant DHT as "DHT Storage Nodes"
  participant META as "local/storage/metadata/*.toml"

  CLI->>KS: "LoadAndStoreFileRemote(local_path, handler)"
  KS->>KS: "HashFile + CalculateBlockSize + PrepareMetaData"
  KS->>RH: "StartReceiver(metadata)"

  loop "for chunk_index in [0..TotalBlocks-1]"
    KS->>KS: "computeChunkKey(file_hash, chunk_index)"
    KS->>RH: "PassFileReference(file_ref, chunk_bytes)"
    RH->>DHT: "STORE(key, ref, data, request_id, trace_id)"
    DHT-->>RH: "ACK/NACK(chunk_id, reason)"
  end

  KS->>META: "fileToMemory(file refs)"
  KS-->>CLI: "File metadata persisted"

  Note over RH,DHT: "Contract mode: cluster_only uses distributed placement as authority."
  Note over KS,META: "Contract mode: hybrid prefers local cache, falls back to cluster."
  Note over RH,DHT: "Current code: DefaultRemoteHandler is still placeholder."
